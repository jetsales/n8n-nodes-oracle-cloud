name: AI Code Review
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  # ===========================================================================
  # Job de Valida√ß√£o: Validar secrets antes de executar revis√£o
  # ===========================================================================
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate required secrets
        id: validate-secrets
        run: |
          echo "üîç Validando secrets obrigat√≥rios..."

          # Validar OPENAI_API_KEY (obrigat√≥rio)
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "::error::OPENAI_API_KEY n√£o est√° configurado"
            echo "::error::Configure o secret em: Settings > Secrets > Actions"
            echo "error=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ OPENAI_API_KEY configurado"
          echo "error=false" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Job Principal: Executar revis√£o de c√≥digo por IA
  # ===========================================================================
  ai_review:
    needs: validate
    if: needs.validate.result == 'success'
    uses: jetsales/ai-code-review-workflow/.github/workflows/ai-code-review.yaml@main
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      # NODE_AUTH_TOKEN: Token opcional para autentica√ß√£o em pacotes privados do npm
      # Mapeado de GPR_TOKEN_PLATFORMS_CLASSIC (GitHub Package Registry token)
      # Se n√£o configurado, o workflow funcionar√° normalmente, mas pacotes privados n√£o estar√£o dispon√≠veis
      NODE_AUTH_TOKEN: ${{ secrets.GPR_TOKEN_PLATFORMS_CLASSIC }}

  # ===========================================================================
  # Job de Tratamento de Erros: Sempre executa para reportar erros
  # ===========================================================================
  error_handling:
    runs-on: ubuntu-latest
    needs: [validate, ai_review]
    if: always()
    steps:
      - name: Error handling and summary
        run: |
          echo "================================================"
          echo "üìä RESUMO DA EXECU√á√ÉO DO WORKFLOW"
          echo "================================================"
          echo ""

          # Verificar se valida√ß√£o de secrets falhou
          if [ "${{ needs.validate.result }}" == "failure" ]; then
            echo "‚ùå Status: FALHA - Valida√ß√£o de secrets"
            echo "‚ö†Ô∏è  O workflow falhou durante a valida√ß√£o de secrets obrigat√≥rios"
            echo ""
            echo "A√ß√£o necess√°ria:"
            echo "1. V√° para Settings > Secrets > Actions"
            echo "2. Adicione o secret OPENAI_API_KEY"
            echo "3. Execute o workflow novamente"
            exit 1
          fi

          # Verificar se o workflow de revis√£o falhou
          if [ "${{ needs.ai_review.result }}" == "failure" ]; then
            echo "‚ùå Status: FALHA - Revis√£o de c√≥digo"
            echo "‚ö†Ô∏è  O workflow de revis√£o falhou durante a execu√ß√£o"
            echo ""
            echo "Verifique os logs do job 'ai_review' para mais detalhes sobre o erro"
            exit 1
          fi

          # Verificar se foi cancelado
          if [ "${{ needs.ai_review.result }}" == "cancelled" ]; then
            echo "‚ö†Ô∏è  Status: CANCELADO"
            echo "O workflow foi cancelado antes de completar"
            exit 1
          fi

          # Sucesso
          if [ "${{ needs.ai_review.result }}" == "success" ]; then
            echo "‚úÖ Status: SUCESSO"
            echo "üí¨ Revis√£o de c√≥digo por IA conclu√≠da com sucesso"
            echo "üìù Verifique o coment√°rio no PR para ver a revis√£o"
          fi

          echo ""
          echo "================================================"

